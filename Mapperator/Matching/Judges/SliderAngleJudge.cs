using Mapperator.Model;
using Mapping_Tools_Core.MathUtil;

namespace Mapperator.Matching.Judges;

public class SliderAngleJudge : IJudge {
    // Slider angle probability density values from Sotarks maps
    private const int AngleBins = 629;
    private static readonly double[] Probs = {
        0.5841053882, 1.202170392, 1.079915776, 1.107083468, 1.134251161, 1.2632977, 1.392344239, 1.446679624, 1.704772703, 1.860986934, 2.146247705, 2.132663859, 2.533387323, 2.519803477, 2.519803477, 2.628474247, 2.655641939, 3.097116942, 3.022405788, 2.85260771, 3.015613865, 2.913735018, 3.097116942, 2.900151172, 2.74393694, 2.472260015, 2.404340784, 2.214166937, 2.064744628, 2.261710398, 1.983241551, 1.89494655, 1.976449627, 1.759108088, 1.331216931, 1.331216931, 1.276881546, 1.195378469, 1.093499622, 0.9033257748, 0.916909621, 0.8761580823, 0.916909621, 0.8897419285, 0.7878630817, 0.7199438506, 0.6384407731, 0.63164885, 0.4550588489, 0.4075153871, 0.4822265414, 0.4686426952, 0.5433538495, 0.3871396178, 0.3735557715, 0.3735557715, 0.3871396178, 0.2716769247, 0.285260771, 0.3192203866, 0.2716769247, 0.2784688479, 0.3328042328, 0.1901738473, 0.1833819242, 0.2173415398, 0.230925386, 0.230925386, 0.1630061548, 0.1969657704, 0.2105496167, 0.230925386, 0.2037576936, 0.2173415398, 0.1969657704, 0.2037576936, 0.1562142317, 0.1358384624, 0.2173415398, 0.230925386, 0.0747111543, 0.2105496167, 0.1630061548, 0.1290465393, 0.1426303855, 0.1765900011, 0.1562142317, 0.2037576936, 0.2173415398, 0.1494223086, 0.1901738473, 0.1222546161, 0.1426303855, 0.1969657704, 0.1358384624, 0.115462693, 0.1765900011, 0.2105496167, 0.2037576936, 0.1290465393, 0.169798078, 0.1630061548, 0.1494223086, 0.1765900011, 0.1901738473, 0.2241334629, 0.2716769247, 0.230925386, 0.2105496167, 0.230925386, 0.230925386, 0.2513011554, 0.2037576936, 0.2513011554, 0.3192203866, 0.2920526941, 0.5093942339, 0.3599719253, 0.4822265414, 0.5569376957, 0.5637296188, 0.4754346183, 0.6044811575, 0.5976892344, 0.6588165425, 0.7403196199, 0.7810711586, 1.032372314, 1.018788468, 1.242921931, 1.297257316, 1.338008854, 1.467055394, 1.793067703, 1.969657704, 2.078328474, 2.404340784, 2.32962963, 2.533387323, 2.798272325, 2.954486557, 2.927318864, 2.920526941, 2.709977324, 2.968070403, 2.499427708, 2.343213476, 2.132663859, 2.030785012, 1.854195011, 1.704772703, 1.58931001, 1.433095778, 1.100291545, 1.04595616, 1.15462693, 1.04595616, 1.487431163, 0.9644530828, 1.181794623, 1.324425008, 1.297257316, 1.494223086, 1.711564626, 2.051160782, 2.295670014, 2.350005399, 2.567346939, 2.587722708, 2.546971169, 2.954486557, 2.777896555, 2.839023864, 2.465468092, 2.94090271, 2.682809632, 2.20058309, 2.051160782, 1.928906166, 1.908530396, 1.657229241, 1.141043084, 1.541766548, 1.317633085, 0.9712450059, 0.9712450059, 0.8965338516, 0.8354065436, 0.6724003887, 0.6791923118, 0.5908973113, 0.6791923118, 0.6180650038, 0.5093942339, 0.3667638484, 0.5501457726, 0.4482669258, 0.3735557715, 0.3939315409, 0.3328042328, 0.3395961559, 0.2716769247, 0.1901738473, 0.2377173091, 0.230925386, 0.2988446172, 0.230925386, 0.1901738473, 0.2377173091, 0.2241334629, 0.1833819242, 0.2241334629, 0.1426303855, 0.169798078, 0.2241334629, 0.1426303855, 0.115462693, 0.1494223086, 0.1765900011, 0.1630061548, 0.1630061548, 0.169798078, 0.1426303855, 0.169798078, 0.04754346183, 0.1426303855, 0.1426303855, 0.1358384624, 0.1833819242, 0.169798078, 0.1833819242, 0.1562142317, 0.1630061548, 0.1969657704, 0.1018788468, 0.1562142317, 0.1630061548, 0.1630061548, 0.1765900011, 0.1901738473, 0.1086707699, 0.2173415398, 0.1969657704, 0.2173415398, 0.1426303855, 0.2716769247, 0.285260771, 0.169798078, 0.1833819242, 0.1833819242, 0.2988446172, 0.230925386, 0.3192203866, 0.2920526941, 0.2037576936, 0.3395961559, 0.2920526941, 0.2784688479, 0.2648850016, 0.3328042328, 0.3531800022, 0.3192203866, 0.4482669258, 0.5841053882, 0.3735557715, 0.4075153871, 0.4958103876, 0.5365619264, 0.5229780801, 0.7131519274, 0.7742792355, 0.9440773135, 0.916909621, 0.7742792355, 0.8693661592, 0.9372853903, 0.8761580823, 1.120667315, 1.107083468, 1.2632977, 1.365176547, 1.820235396, 1.650437318, 1.752316165, 1.928906166, 2.282086168, 2.186999244, 2.350005399, 2.363589245, 2.377173091, 2.818648094, 2.927318864, 2.771104632, 2.655641939, 3.022405788, 2.730353094, 2.676017709, 2.709977324, 2.771104632, 2.485843861, 2.648850016, 2.227750783, 2.350005399, 1.874570781, 2.010409243, 1.969657704, 1.78627578, 1.37196847, 1.256505777, 1.168210776, 1.297257316, 1.222546161, 0.916909621, 1.202170392, 2.057952705, 1.147835007, 1.039164237, 1.073123853, 0.8421984667, 0.916909621, 0.8693661592, 1.04595616, 1.141043084, 1.113875391, 1.15462693, 1.242921931, 1.358384624, 1.555350394, 1.507806932, 1.616477702, 1.69798078, 1.827027319, 1.534974625, 1.664021164, 1.942490012, 2.078328474, 2.017201166, 1.860986934, 1.765900011, 1.779483857, 1.507806932, 1.501015009, 1.473847317, 1.501015009, 1.127459238, 1.222546161, 1.331216931, 1.127459238, 0.9780369291, 1.04595616, 0.9780369291, 0.8421984667, 0.63164885, 0.8218226973, 0.7131519274, 0.6520246194, 0.5297700032, 0.516186157, 0.7131519274, 0.4482669258, 0.5229780801, 0.4822265414, 0.4686426952, 0.4414750027, 0.3871396178, 0.3531800022, 0.4618507721, 0.3395961559, 0.3056365403, 0.2784688479, 0.2920526941, 0.2173415398, 0.2784688479, 0.2648850016, 0.1630061548, 0.2173415398, 0.1562142317, 0.230925386, 0.1630061548, 0.2445092323, 0.1765900011, 0.1969657704, 0.2241334629, 0.2377173091, 0.2716769247, 0.2105496167, 0.1630061548, 0.1290465393, 0.169798078, 0.1901738473, 0.1426303855, 0.1494223086, 0.1494223086, 0.169798078, 0.2173415398, 0.115462693, 0.2241334629, 0.1630061548, 0.115462693, 0.1901738473, 0.2037576936, 0.169798078, 0.1833819242, 0.09508692366, 0.1765900011, 0.1630061548, 0.1290465393, 0.1901738473, 0.1562142317, 0.169798078, 0.230925386, 0.1969657704, 0.2105496167, 0.1833819242, 0.2037576936, 0.1969657704, 0.2105496167, 0.2105496167, 0.2648850016, 0.2513011554, 0.230925386, 0.1969657704, 0.3124284634, 0.2784688479, 0.3599719253, 0.2988446172, 0.3939315409, 0.3531800022, 0.3599719253, 0.4482669258, 0.4686426952, 0.5637296188, 0.5841053882, 0.5433538495, 0.5637296188, 0.6791923118, 0.6044811575, 0.7674873124, 0.9780369291, 0.8557823129, 0.8557823129, 1.073123853, 1.04595616, 1.412720009, 1.548558471, 1.711564626, 1.623269625, 1.935698089, 2.00361732, 2.370381168, 2.533387323, 2.784688479, 2.947694633, 3.239747328, 3.497840406, 3.348418097, 3.518216175, 3.688014253, 3.558967714, 3.165036173, 3.239747328, 2.730353094, 2.771104632, 2.5265954, 2.268502322, 1.867778858, 1.487431163, 1.331216931, 1.113875391, 1.005204622, 1.005204622, 1.270089623, 0.8218226973, 1.005204622, 1.249713854, 1.175002699, 1.399136162, 1.623269625, 1.867778858, 2.037576936, 2.492635784, 2.540179246, 2.730353094, 2.913735018, 3.219371558, 3.232955404, 3.334834251, 3.334834251, 2.519803477, 2.988446172, 2.662433862, 2.513011554, 2.057952705, 2.275294245, 1.827027319, 1.555350394, 1.602893856, 1.270089623, 1.15462693, 0.9916207753, 1.236130008, 0.8965338516, 0.916909621, 0.8354065436, 0.5976892344, 0.5976892344, 0.6927761581, 0.63164885, 0.5637296188, 0.4822265414, 0.4958103876, 0.4414750027, 0.4618507721, 0.3260123097, 0.3260123097, 0.3328042328, 0.3056365403, 0.2920526941, 0.2580930785, 0.230925386, 0.1901738473, 0.2920526941, 0.2377173091, 0.2377173091, 0.2445092323, 0.2173415398, 0.2377173091, 0.2037576936, 0.1358384624, 0.1290465393, 0.1290465393, 0.1833819242, 0.1290465393, 0.1290465393, 0.115462693, 0.169798078, 0.1426303855, 0.1358384624, 0.1426303855, 0.169798078, 0.08829500054, 0.1086707699, 0.1494223086, 0.1426303855, 0.1426303855, 0.1833819242, 0.1630061548, 0.169798078, 0.2513011554, 0.1494223086, 0.169798078, 0.1562142317, 0.2037576936, 0.2105496167, 0.1562142317, 0.1222546161, 0.1833819242, 0.1494223086, 0.1290465393, 0.169798078, 0.285260771, 0.2037576936, 0.1833819242, 0.2241334629, 0.1833819242, 0.3192203866, 0.2648850016, 0.2037576936, 0.230925386, 0.285260771, 0.2784688479, 0.285260771, 0.3124284634, 0.2784688479, 0.3056365403, 0.4143073102, 0.3124284634, 0.4482669258, 0.3667638484, 0.5093942339, 0.4958103876, 0.516186157, 0.7810711586, 0.570521542, 0.6995680812, 0.685984235, 0.801446928, 0.8354065436, 0.8082388511, 0.8693661592, 1.175002699, 0.9916207753, 1.283673469, 1.242921931, 1.161418853, 1.344800777, 1.473847317, 1.392344239, 1.616477702, 1.643645395, 1.630061548, 1.867778858, 1.820235396, 1.799859626, 2.241334629, 1.996825397, 2.20058309, 2.132663859, 2.248126552, 2.078328474, 1.956073858, 2.322837707, 1.847403088, 1.684396933, 1.881362704, 1.548558471, 1.48063924, 1.521390779, 1.310841162, 1.181794623, 1.188586546, 1.283673469, 1.059540006, 1.15462693, 1.100291545, 1.059540006, 1.06633193, 1.120667315, 1.793067703
    };

    public double Angle { get; set; }

    public double Judge(Match match) {
        var angle = Angle;
        var score = 1d;

        for (var i = 0; i < match.Sequence.Length; i++) {
            var dataPoint = match.Sequence.Span[i];
            angle += dataPoint.Angle;

            if (dataPoint.DataType != DataType.Release) continue;

            var angleClass = MathHelper.Clamp((int)Math.Round((angle + Math.PI) * 100), 0, AngleBins - 1);
            score = Probs[angleClass];
            break;
        }

        return score;
    }

    public int MinLengthForScore(double wantedScore) {
        return 1;
    }
}